#!/bin/bash

# Definir PASTEBIN API KEY
PASTEBIN_API_KEY="cvPMpeOkL2hT9cOWQpDFBa7luqyDmmX8"

# Limpiar la pantalla
clear

echo "\033[1;37m"
echo "       #########################"
echo "       #    MalwareDetector    #"
echo "       #                       #"
echo "       #       -By HeyArnoldo  #"
echo "       #########################"
echo "       #   Presiona Ctrl + C   #"
echo "       #   Para pararlo        #"
echo "       #########################"
echo ""

sleep 1

echo "\033[0;37m$(date +"%H:%M:%S") \033[1;36m[AntiMalware] \033[0;37m[\033[1;33m⚠︎\033[0;37m] \033[1;36mDownloading MalwareDetector..."

DOWNLOAD_ANTI_MALWARE="wget https://github.com/OpticFusion1/MCAntiMalware/releases/download/15.14/MCAntiMalware.jar"
$DOWNLOAD_ANTI_MALWARE

# Verificar si la descarga fue exitosa
if [ $? -ne 0 ]; then
    echo "\033[0;37m$(date +"%H:%M:%S") \033[1;36m[AntiMalware] \033[0;37m[\033[1;31m✘\033[0;37m] \033[1;36mError: Failed to download MCAntiMalware.jar."
    exit 1
fi

echo "\033[0;37m$(date +"%H:%M:%S") \033[1;36m[AntiMalware] \033[0;37m[\033[1;32m✔\033[0;37m] \033[1;36mSuccessfully downloaded MalwareDetector :)"
echo "\033[0;37m$(date +"%H:%M:%S") \033[1;36m[AntiMalware] \033[0;37m[\033[1;33m⚠︎\033[0;37m] \033[1;36mStarting Analisis..."

sleep 1

# Ejecutar el análisis y redirigir la salida a un archivo de logs
ANALISIS="timeout 10s java -jar MCAntiMalware.jar > malware_detection.log 2>&1"
echo "Ejecutando comando: $ANALISIS"  # Debugging: Mostrar el comando exacto ejecutado
eval $ANALISIS  # Usar eval para asegurar que la redirección funcione correctamente

# Verificar si el archivo de logs tiene contenido
if [ -s "malware_detection.log" ]; then
    # Subir el archivo de logs a Pastebin y obtener el enlace
    echo "\033[0;37m$(date +"%H:%M:%S") \033[1;36m[AntiMalware] \033[0;37m[\033[1;33m⚠︎\033[0;37m] \033[1;36mUploading logs to Pastebin..."
    PASTEBIN_URL=$(curl -s -d "api_dev_key=$PASTEBIN_API_KEY" \
                            -d "api_option=paste" \
                            -d "api_paste_name=MalwareDetectionLogs" \
                            -d "api_paste_code=$(cat malware_detection.log)" \
                            https://pastebin.com/api/api_post.php)

    echo "\033[0;37m$(date +"%H:%M:%S") \033[1;36m[AntiMalware] \033[0;37m[\033[1;32m✔\033[0;37m] \033[1;36mLogs uploaded to Pastebin. Here is the link: $PASTEBIN_URL"

    # Eliminar el archivo de logs después de subirlo
    echo "\033[0;37m$(date +"%H:%M:%S") \033[1;36m[AntiMalware] \033[0;37m[\033[1;33m⚠︎\033[0;37m] \033[1;36mDeleting log file..."
    rm malware_detection.log
else
    echo "\033[0;37m$(date +"%H:%M:%S") \033[1;36m[AntiMalware] \033[0;37m[\033[1;31m✘\033[0;37m] \033[1;36mError: The log file 'malware_detection.log' is empty or does not exist."
    echo "Contenido actual del directorio:"
    ls -lh  # Mostrar el contenido del directorio para verificar la existencia del archivo
    echo "Últimas líneas del log:"
    tail malware_detection.log  # Mostrar las últimas líneas del archivo de logs para diagnóstico
fi

echo "\033[0;37m$(date +"%H:%M:%S") \033[1;36m[AntiMalware] \033[0;37m[\033[1;33m⚠︎\033[0;37m] \033[1;36mAnalisis finished, check the results in the console."

sleep 1

echo "\033[0;37m$(date +"%H:%M:%S") \033[1;36m[AntiMalware] \033[0;37m[\033[1;33m⚠︎\033[0;37m] \033[1;36mDeleting MalwareDetector..."

DELETE_ANTI_MALWARE="rm MCAntiMalware.jar && rm -rf AntiMalware"
$DELETE_ANTI_MALWARE

echo "\033[0;37m$(date +"%H:%M:%S") \033[1;36m[AntiMalware] \033[0;37m[\033[1;32m✔\033[0;37m] \033[1;36mSuccessfully deleted MalwareDetector"
echo "\033[0;37m$(date +"%H:%M:%S") \033[1;36m[AntiMalware] \033[0;37m[\033[1;32m✔\033[0;37m] \033[1;36mAntiMalware finished, have a nice day :)"
